# Введение в работу с Gemini

[Gemini](https://github.com/bem/gemini) – это утилита для регрессионного тестирования отображения веб-страниц.

Ключевые возможности:

* Работа в различных браузерах
* Тестирование фрагментов веб-страниц
* Учет свойств `box-shadow` и `outline` при вычислении позиции элемента
* Игнорирование не ошибочных различий между изображениями (артефакты рендеринга, текстовая каретка)
* Сбор статистики покрытия CSS-кода тестами.

Gemini создан в [Яндексе](http://www.yandex.com/) и используется разработчиками библиотек блоков.

Данный документ шаг за шагом описывает установку и настройку Gemini и предназначен для быстрого старта работы с утилитой.

## Установка стороннего ПО

Перед началом работы с Gemini необходимо установить следующее программное обеспечение:

1. [GraphicsMagick](http://www.graphicsmagick.org/README.html) - пакет программ для обработки графических файлов.  
Для установки пакета на Mac OS X можно воспользоваться командой `brew install graphicsmagick` пакетного менеджера [Homebrew](http://brew.sh/).
2. [Selenium Server](http://www.seleniumhq.org/download/) - необходим для тестирования в различных 
браузерах.
3. [PhantomJS](http://phantomjs.org/) - консольный аналог WebKit-браузера.


## Глобальная установка Gemini

Для установки утилиты используется команда `install` пакетного менеджера [npm](https://www.npmjs.org/):

```
    npm install -g gemini
```

Глобальная инсталляция будет использоваться для запуска команд.

## Локальная установка

Для написания тестов нам также понадобится локальная установка `gemini`. В папке проекта выполните команду:

```
npm install gemini
```

Локальная копия будет использоваться для написания тестов.

## Настройка

Дополнительная настройка утилиты происходит путем редактирования конфигурационного файла `.gemini.yml`, который расположен в корневой папке проекта.

### Для использования с PhantomJS

Самый простейший вариант настройки предполагает использование только локально установленного `PhantomJS`.
В этом случае, достаточно указать только параметр `rootUrl` – корневой URL нашего сайта. Например:

```yaml
rootUrl: http://yandex.com
```

Также, в этом случае необходимо вручную запустить `Phantom.JS` в режиме `WebDriver`:

```
phantomjs --webdriver=4444
```

### Использование с Selenium

Для тестирования в различных браузеров нужно использовать `Selenium`. Вы можете воспользоваться удаленным
`Selenium Grid`, облачным провайдером (таким, как [SauceLabs](http://saucelabs.com/) или 
[BrowserStack](http://www.browserstack.com/)) или запустить сервер локально:

```
java -jar selenium-server-standalone.jar
```

В конфигурационном файле вам надо будет дополнительно указать адрес `Selenium`-сервера
и список браузеров для тестирования:

```yaml
rootUrl: http://yandex.com
gridUrl: http://localhost:4444/wd/hub

browsers:
  chrome:
    browserName: chrome
    version: "37.0"

  firefox:
    browserName: firefox
    version: "31.0"

```

В качестве ключей в `browsers` используются уникальные идентификаторы браузеров (произвольная строка, 
выбираемая пользователем), а в качестве значения [`DesiredCapabilites`](https://code.google.com/p/selenium/wiki/DesiredCapabilities) данного браузера.

### Другие опции

[Подробнее](https://github.com/jk708/gemini/blob/restructuring-docs/doc/config.ru.md) о структуре конфигурационного
файла.

## Создание тестов

Каждый тестируемый блок может находиться в одном из нескольких фиксированных состояний. Состояния проверяются с помощью цепочек последовательных действий, описанных в тестовых наборах блока.

Для примера, напишем тест для поискового блока на [yandex.com](http://www.yandex.com):

```javascript
var gemini = require('gemini');

gemini.suite('yandex-search', function(suite) {
    suite.setUrl('/')
        .setCaptureElements('.main-table')
        .capture('plain')
        .capture('with text', function(actions, find) {
            actions.sendKeys(find('.input__control'), 'hello gemini');
        });
});
```

В этом примере мы создаем новый тестовый набор `yandex-search`, говорим, что будем снимать элемент `.main-table`
c корневого URL `http://yandex.com`. У блока есть два состояния:

* `plain` – сразу после загрузки страницы;
* `with text` - c введенным в элемент `.input__control` текстом `hello gemini`.

Состояния выполняются последовательно в порядке определения без перезагрузки страницы между ними.

[Подробнее](https://github.com/jk708/gemini/blob/restructuring-docs/doc/tests.ru.md) о методах создания тестов.

## Сбор эталонных снимков

Для того чтобы закончить тест, нужно также сделать эталонные снимки. Делается это командой:

```
gemini gather [путь к файлам с тестами]
```

Если путь не задан, будут выполнены все js-файлы в папке `gemini` в текущей директории.
По умолчанию, снимки будут сохранены в папку `gemini/screens`

Рекомендуется сохранить собранные эталоны вместе с кодом под контролем версий.

## Запуск тестов

Для запуска тестов используется команда:

```
gemini test [путь к файлам с тестами]
```

`Gemini` запустит тесты, снимет новые изображения, и сообщит если обнаружит различия.

Чтобы наглядно увидеть разницу между текущим изображением и эталоном (diff) можно воспользоваться `html`-отчетом:

```
gemini test --reporter html [путь к файлам с тестами]

```

Можно использовать консольный и `html`-отчет одновременно:

```
gemini test --reporter html --reporter flat [путь к файлам с тестами]

```

## Подробности о CLI

[Подробнее](https://github.com/jk708/gemini/blob/restructuring-docs/doc/tests.ru.md) о работе с командной строкой и доступных аргументах.

## GUI

Вместо командой строки можно воспользоваться графическим интерфейсом. Он находится в пакете 
[`gemini-gui`](https://github.com/bem/gemini-gui) и устанавливается отдельно:

```
npm install -g gemini-gui
```

Преимущества GUI:
* удобный просмотр эталонов
* показ наглядных различий между эталоном и текущим состоянием в реальном времени
* возможность легкого обновления эталонных изображений

## Gemini API

Программный интерфейс Gemini позволяет использовать утилитy в качестве инструмента тестирования в скриптах и инструментах сборки.

[Подробнее](https://github.com/jk708/gemini/blob/restructuring-docs/doc/programmatic-api.ru.md) о Gemini API.
